<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Bus - Punjab Transport</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Maps JavaScript API -->
    <!-- Replace YOUR_GOOGLE_MAPS_API_KEY with your actual API key -->
    <script async defer 
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0p0-2n_otSc39b2N4LeennvO7DZ5mXbA&libraries=geometry,places,visualization&callback=initGoogleMaps">
    </script>
    
    <!-- MapmyIndia (Mappls) SDK - Currently disabled until API key is configured -->
    <!-- Uncomment and add your API key when ready: -->
    <!-- <script src="https://apis.mappls.com/advancedmaps/api/YOUR-API-KEY/map_sdk?layer=vector&v=3.0&callback=initializeApp"></script> -->
    
    <!-- Leaflet as fallback when Google Maps is not available -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="../JS/config.js"></script>
    <script src="../JS/common.js"></script>
    <script src="../JS/firebase-enhanced.js"></script>
    <style>
        .bus-marker {
            background: #ea580c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            position: relative;
        }
        .bus-marker::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #ea580c;
        }
        .user-marker {
            background: #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Ensure map container has proper dimensions */
        #map {
            height: 100vh;
            min-height: 500px;
            width: 100%;
        }
        
        /* Fix for map container on mobile */
        @media (max-width: 768px) {
            #map {
                height: calc(100vh - 64px); /* Account for header */
            }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <!-- Header -->
    <div class="bg-orange-600 text-white p-4 shadow-lg fixed w-full top-0 z-40">
        <div class="max-w-full mx-auto flex items-center justify-between px-4">
            <h1 class="text-xl md:text-2xl font-bold flex items-center">
                <i class="fas fa-bus mr-2"></i> Track Your Bus
            </h1>
            <a href="index.html" class="bg-white text-orange-600 px-3 py-1 md:px-4 md:py-2 rounded-lg hover:bg-gray-100 transition text-sm md:text-base">
                <i class="fas fa-home mr-1 md:mr-2"></i> Home
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex h-screen pt-16">
        <!-- Sidebar -->
        <div id="sidebar" class="w-full md:w-96 bg-white shadow-lg overflow-y-auto transition-all duration-300 absolute md:relative z-30 h-full">
            <!-- Mobile Toggle -->
            <button onclick="toggleSidebar()" class="md:hidden absolute right-4 top-4 text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="p-4 space-y-4">
                <!-- Search Section -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h2 class="text-lg font-semibold mb-3 text-gray-800">Find Your Bus</h2>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-600 mb-1 block">Select City</label>
                            <select id="citySelect" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                <option value="">Choose a city...</option>
                                <option value="chandigarh">Chandigarh</option>
                                <option value="ludhiana">Ludhiana</option>
                                <option value="amritsar">Amritsar</option>
                                <option value="jalandhar">Jalandhar</option>
                                <option value="patiala">Patiala</option>
                                <option value="bathinda">Bathinda</option>
                                <option value="mohali">Mohali</option>
                                <option value="pathankot">Pathankot</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-sm text-gray-600 mb-1 block">Select Route</label>
                            <select id="routeSelect" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" disabled>
                                <option value="">Choose a route...</option>
                            </select>
                        </div>

                        <button onclick="trackBuses()" class="w-full bg-orange-600 text-white p-3 rounded-lg hover:bg-orange-700 transition flex items-center justify-center font-semibold">
                            <i class="fas fa-search mr-2"></i> Search Buses
                        </button>
                    </div>
                </div>

                <!-- Your Location -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Your Location</h3>
                    <button onclick="getUserLocation()" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                        <i class="fas fa-location-crosshairs mr-2"></i> Get My Location
                    </button>
                    <div id="userLocationInfo" class="mt-3 hidden">
                        <div class="bg-white p-3 rounded-lg">
                            <p class="text-sm text-gray-600">üìç <span id="userAddress">Fetching address...</span></p>
                            <p class="text-xs text-gray-500 mt-1">Lat: <span id="userLat">0</span>, Lng: <span id="userLng">0</span></p>
                        </div>
                    </div>
                </div>

                <!-- Active Buses List -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center justify-between">
                        Active Buses
                        <span id="busCount" class="text-sm bg-orange-100 text-orange-600 px-2 py-1 rounded-full">0</span>
                    </h3>
                    <div id="busList" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-bus text-4xl mb-2"></i>
                            <p>Select a route to see active buses</p>
                        </div>
                    </div>
                </div>

                <!-- Nearby Stops with Enhanced Features -->
                <div id="nearbyStops" class="hidden">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Nearby Stops</h3>
                    <div id="stopsList" class="space-y-2">
                        <!-- Stops will be populated here -->
                    </div>
                </div>

                <!-- Live Arrival Predictions -->
                <div id="arrivalPredictions" class="hidden">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center">
                        üìç Live Arrivals
                        <span class="ml-2 text-xs bg-green-100 text-green-600 px-2 py-1 rounded-full">LIVE</span>
                    </h3>
                    <div id="predictionsContent" class="space-y-3">
                        <!-- Live predictions will be populated here -->
                    </div>
                </div>

                <!-- Service Alerts -->
                <div id="serviceAlerts" class="hidden">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800 flex items-center">
                        üö® Service Alerts
                        <span class="ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full">ALERTS</span>
                    </h3>
                    <div id="alertsContent" class="space-y-2">
                        <!-- Service alerts will be populated here -->
                    </div>
                </div>

                <!-- Journey Planner -->
                <div id="journeyPlanner" class="bg-green-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Plan Your Journey</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-600 mb-1 block">From (Stop)</label>
                            <select id="fromStop" class="w-full p-2 border rounded-lg text-sm">
                                <option value="">Select origin stop...</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-gray-600 mb-1 block">To (Stop)</label>
                            <select id="toStop" class="w-full p-2 border rounded-lg text-sm">
                                <option value="">Select destination stop...</option>
                            </select>
                        </div>
                        <button onclick="planJourney()" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition text-sm">
                            Plan Journey
                        </button>
                        <div id="journeyResults" class="hidden">
                            <!-- Journey plan results will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="flex-1 relative">
            <!-- Mobile Menu Button -->
            <button onclick="toggleSidebar()" class="md:hidden absolute top-4 left-4 z-20 bg-white p-3 rounded-lg shadow-lg">
                <i class="fas fa-bars text-gray-600"></i>
            </button>

            <!-- Map -->
            <div id="map" class="w-full h-full"></div>

            <!-- Map Controls -->
            <div class="absolute bottom-4 right-4 space-y-2 z-20">
                <button onclick="centerOnUser()" class="bg-white p-3 rounded-lg shadow-lg hover:bg-gray-100 transition" title="Center on my location">
                    <i class="fas fa-crosshairs text-gray-600"></i>
                </button>
                <button onclick="fitAllBuses()" class="bg-white p-3 rounded-lg shadow-lg hover:bg-gray-100 transition" title="Show all buses">
                    <i class="fas fa-expand text-gray-600"></i>
                </button>
                <button onclick="toggleAutoFollow()" id="autoFollowBtn" class="bg-white p-3 rounded-lg shadow-lg hover:bg-gray-100 transition" title="Auto follow buses">
                    <i class="fas fa-location-arrow text-gray-600"></i>
                </button>
            </div>

            <!-- Live Info Panel -->
            <div id="liveInfoPanel" class="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-4 hidden z-20 max-w-sm">
                <h4 class="font-semibold text-gray-800 mb-2">Live Updates</h4>
                <div id="liveInfoContent" class="text-sm">
                    <!-- Live info will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bus Details Modal -->
    <div id="busModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-4 flex items-center justify-between">
                <h3 class="text-xl font-semibold">Bus Details</h3>
                <button onclick="closeBusModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="busModalContent" class="p-4">
                <!-- Bus details will be populated here -->
            </div>
        </div>
    </div>

    <script src="../JS/user-app.js"></script>
</body>
</html>